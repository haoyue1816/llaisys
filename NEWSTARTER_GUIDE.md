# ğŸ“ æ–°æ‰‹å®Œæ•´æŒ‡å—ï¼šå®ç°å¼ é‡æ“ä½œå‡½æ•°

## ğŸ“‹ ä»»åŠ¡æ¦‚è§ˆ

ä½ éœ€è¦åœ¨è¿™ä¸ªæ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­å®ç° **5ä¸ªå‡½æ•°**ï¼š

| å‡½æ•°å | åŠŸèƒ½ | éš¾åº¦ |
|--------|------|------|
| `load()` | ä»CPUå¤åˆ¶æ•°æ®åˆ°å¼ é‡ | â­ ç®€å• |
| `isContiguous()` | æ£€æŸ¥å†…å­˜æ˜¯å¦è¿ç»­ | â­â­ ä¸­ç­‰ |
| `view()` | æ”¹å˜å½¢çŠ¶ï¼ˆä¸å¤åˆ¶æ•°æ®ï¼‰ | â­â­â­ è¾ƒéš¾ |
| `permute()` | è°ƒæ•´ç»´åº¦é¡ºåº | â­â­â­ è¾ƒéš¾ |
| `slice()` | åˆ‡ç‰‡æ“ä½œ | â­â­â­ è¾ƒéš¾ |

---

## ğŸ“š ç¬¬ä¸€æ­¥ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯å¼ é‡ï¼ˆTensorï¼‰ï¼Ÿ

å¼ é‡å°±æ˜¯ä¸€ä¸ª**å¤šç»´æ•°ç»„**ï¼Œå°±åƒNumPyæ•°ç»„æˆ–PyTorchå¼ é‡ã€‚

**ä¾‹å­**ï¼š
```python
# å½¢çŠ¶ä¸º (3, 4, 5) çš„å¼ é‡
# è¿™æ˜¯ä¸€ä¸ª3ç»´æ•°ç»„ï¼š
# - ç¬¬0ç»´ï¼š3ä¸ªå…ƒç´ 
# - ç¬¬1ç»´ï¼šæ¯ä¸ªå…ƒç´ æœ‰4ä¸ªå­å…ƒç´ 
# - ç¬¬2ç»´ï¼šæ¯ä¸ªå­å…ƒç´ æœ‰5ä¸ªå€¼
```

### 1.2 ä»€ä¹ˆæ˜¯Shapeï¼ˆå½¢çŠ¶ï¼‰ï¼Ÿ

`shape` å‘Šè¯‰æˆ‘ä»¬å¼ é‡æ¯ä¸ªç»´åº¦çš„å¤§å°ã€‚

```cpp
shape = {3, 4, 5}  // 3ç»´å¼ é‡ï¼š3Ã—4Ã—5 = 60ä¸ªå…ƒç´ 
```

### 1.3 ä»€ä¹ˆæ˜¯Strideï¼ˆæ­¥é•¿ï¼‰ï¼Ÿ

`stride` å‘Šè¯‰æˆ‘ä»¬åœ¨å†…å­˜ä¸­ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ éœ€è¦è·³è¿‡å¤šå°‘å­—èŠ‚ã€‚

**å¯è§†åŒ–ä¾‹å­**ï¼š
```
ä¸€ä¸ª (2, 3) çš„å¼ é‡ï¼š
[[1, 2, 3],
 [4, 5, 6]]

å†…å­˜ä¸­çš„å®é™…å­˜å‚¨ï¼š[1, 2, 3, 4, 5, 6]

shape = [2, 3]
strides = [3, 1]  // ï¼ˆæŒ‰å…ƒç´ ä¸ªæ•°è®¡ç®—ï¼‰

è§£é‡Šï¼š
- è¦ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œï¼ˆç¬¬0ç»´ï¼‰ï¼šè·³è¿‡3ä¸ªå…ƒç´ 
- è¦ç§»åŠ¨åˆ°ä¸‹ä¸€åˆ—ï¼ˆç¬¬1ç»´ï¼‰ï¼šè·³è¿‡1ä¸ªå…ƒç´ 
```

### 1.4 ä»€ä¹ˆæ˜¯Contiguousï¼ˆè¿ç»­ï¼‰ï¼Ÿ

å¼ é‡æ˜¯**è¿ç»­çš„**ï¼Œå¦‚æœï¼š
1. å…ƒç´ åœ¨å†…å­˜ä¸­æŒ‰é¡ºåºç´§å¯†æ’åˆ—
2. æ²¡æœ‰é—´éš™
3. å¯ä»¥ç”¨ä¸€ç»´æŒ‡é’ˆéå†æ‰€æœ‰å…ƒç´ 

**æ£€æŸ¥æ–¹æ³•**ï¼š
```cpp
// å¯¹äºè¿ç»­å¼ é‡ï¼Œstridesåº”è¯¥æ»¡è¶³ï¼š
// strides[i] = strides[i+1] * shape[i+1]

ä¾‹å­ï¼šshape = [2, 3, 5]
è¿ç»­çš„ strides = [15, 5, 1]
éªŒè¯ï¼š15 == 5 * 3 âœ“,  5 == 1 * 5 âœ“
```

---

## ğŸ“‚ ç¬¬äºŒæ­¥ï¼šæ‰¾åˆ°ä½ è¦ä¿®æ”¹çš„æ–‡ä»¶

### æ–‡ä»¶ä½ç½®ï¼š
```
/home/haoyue/workspace/llaisys/src/tensor/tensor.cpp
```

### ä½ éœ€è¦ä¿®æ”¹çš„5ä¸ªå‡½æ•°ä½ç½®ï¼š

| è¡Œå· | å‡½æ•° |
|------|------|
| 166-169 | `isContiguous()` |
| 171-174 | `permute()` |
| 176-179 | `view()` |
| 181-184 | `slice()` |
| 186-188 | `load()` |

---

## ğŸ” ç¬¬ä¸‰æ­¥ï¼šç†è§£ç°æœ‰ä»£ç ï¼ˆé‡è¦ï¼ï¼‰

### 3.1 å¯ç”¨çš„æˆå‘˜å˜é‡

```cpp
class Tensor {
private:
    TensorMeta _meta;        // åŒ…å« dtype, shape, strides
    core::storage_t _storage; // å†…å­˜ç®¡ç†
    size_t _offset;          // å†…å­˜åç§»é‡
};
```

### 3.2 å¯ç”¨çš„è¾…åŠ©å‡½æ•°

```cpp
// è·å–æ•°æ®æŒ‡é’ˆ
std::byte *data();

// è·å–å½¢çŠ¶
const std::vector<size_t> &shape() const;

// è·å–æ­¥é•¿
const std::vector<ptrdiff_t> &strides() const;

// è·å–å…ƒç´ æ€»æ•°é‡
size_t numel() const;

// è·å–æ¯ä¸ªå…ƒç´ çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰
size_t elementSize() const;

// è·å–è®¾å¤‡ç±»å‹
llaisysDeviceType_t deviceType() const;

// è·å–è®¾å¤‡ID
int deviceId() const;
```

### 3.3 å¦‚ä½•è·å–è¿è¡Œæ—¶APIï¼ˆç”¨äºå†…å­˜å¤åˆ¶ï¼‰

ä» `debug()` å‡½æ•°å­¦ä¹ ï¼ˆç¬¬150-161è¡Œï¼‰ï¼š

```cpp
// 1. è®¾ç½®è®¾å¤‡ä¸Šä¸‹æ–‡
core::context().setDevice(this->deviceType(), this->deviceId());

// 2. ä½¿ç”¨è¿è¡Œæ—¶APIè¿›è¡Œå†…å­˜å¤åˆ¶
core::context().runtime().api()->memcpy_sync(
    ç›®æ ‡æŒ‡é’ˆ,
    æºæŒ‡é’ˆ,
    å­—èŠ‚æ•°,
    å¤åˆ¶ç±»å‹
);
```

### 3.4 å†…å­˜å¤åˆ¶ç±»å‹

```cpp
LLAISYS_MEMCPY_H2H  // Host to Host (CPUåˆ°CPU)
LLAISYS_MEMCPY_H2D  // Host to Device (CPUåˆ°GPU)
LLAISYS_MEMCPY_D2H  // Device to Host (GPUåˆ°CPU)
LLAISYS_MEMCPY_D2D  // Device to Device (GPUåˆ°GPU)
```

---

## ğŸ’» ç¬¬å››æ­¥ï¼šå¼€å§‹å®ç°ï¼ˆæŒ‰é¡ºåºï¼‰

### âœ… ä»»åŠ¡1ï¼š`load()` - æœ€ç®€å•ï¼Œä»è¿™é‡Œå¼€å§‹ï¼

**åŠŸèƒ½**ï¼šä»CPUå†…å­˜å¤åˆ¶æ•°æ®åˆ°å¼ é‡

**å®ç°æ­¥éª¤**ï¼š
1. è®¾ç½®è®¾å¤‡ä¸Šä¸‹æ–‡
2. è®¡ç®—éœ€è¦å¤åˆ¶çš„å­—èŠ‚æ•°
3. è°ƒç”¨ `memcpy_sync` ä»ä¸»æœºå¤åˆ¶åˆ°è®¾å¤‡

**ä»£ç æ¡†æ¶**ï¼š
```cpp
void Tensor::load(const void *src_) {
    // TODO: å®ç°è¿™ä¸ªå‡½æ•°
}
```

**æç¤º**ï¼š
- å‚è€ƒ `debug()` å‡½æ•°ï¼ˆç¬¬157-161è¡Œï¼‰
- é‚£é‡Œç”¨çš„æ˜¯ `LLAISYS_MEMCPY_D2H`ï¼ˆè®¾å¤‡åˆ°ä¸»æœºï¼‰
- ä½ è¦ç”¨ `LLAISYS_MEMCPY_H2D`ï¼ˆä¸»æœºåˆ°è®¾å¤‡ï¼‰
- ç›®æ ‡å’Œæºè¦åè¿‡æ¥ï¼

---

### âœ… ä»»åŠ¡2ï¼š`isContiguous()`

**åŠŸèƒ½**ï¼šæ£€æŸ¥å¼ é‡å†…å­˜æ˜¯å¦è¿ç»­

**å®ç°æ­¥éª¤**ï¼š
1. æ£€æŸ¥æœ€åä¸€ä¸ªç»´åº¦çš„strideæ˜¯å¦ç­‰äº `elementSize()`
2. æ£€æŸ¥å…¶ä»–ç»´åº¦çš„strideæ˜¯å¦æ»¡è¶³å…¬å¼

**ä»£ç æ¡†æ¶**ï¼š
```cpp
bool Tensor::isContiguous() const {
    // TODO: å®ç°è¿™ä¸ªå‡½æ•°
    return true;
}
```

**æç¤º**ï¼š
- ä»æœ€åä¸€ç»´å¼€å§‹æ£€æŸ¥
- ä½¿ç”¨å¾ªç¯éªŒè¯æ¯ä¸ªç»´åº¦çš„stride
- å…¬å¼ï¼š`strides[i] == strides[i+1] * shape[i+1]`

---

### âœ… ä»»åŠ¡3ï¼š`view()`

**åŠŸèƒ½**ï¼šæ”¹å˜å¼ é‡å½¢çŠ¶ï¼ˆä¸å¤åˆ¶æ•°æ®ï¼‰

**é‡è¦æç¤º**ï¼šä¸æ˜¯ç®€å•çš„æ”¹å˜shapeï¼
- å¿…é¡»éªŒè¯æ–°å½¢çŠ¶ä¸åŸå¼ é‡å…¼å®¹
- æ£€æŸ¥å…ƒç´ æ€»æ•°æ˜¯å¦ç›¸åŒ
- åªå¯¹è¿ç»­å¼ é‡æœ‰æ•ˆï¼ˆæˆ–è€…strideåŒ¹é…ï¼‰

**ä»£ç æ¡†æ¶**ï¼š
```cpp
tensor_t Tensor::view(const std::vector<size_t> &shape) const {
    // TODO: å®ç°è¿™ä¸ªå‡½æ•°
    return std::shared_ptr<Tensor>(new Tensor(_meta, _storage));
}
```

---

### âœ… ä»»åŠ¡4ï¼š`permute()`

**åŠŸèƒ½**ï¼šè°ƒæ•´ç»´åº¦é¡ºåºï¼ˆæ¯”å¦‚è½¬ç½®ï¼‰

**ä¾‹å­**ï¼š
```
åŸå§‹å¼ é‡ shape = [2, 3, 4]
permute([2, 0, 1]) å
æ–° shape = [4, 2, 3]
```

**éœ€è¦è®¡ç®—**ï¼š
1. æ–°çš„shapeï¼ˆé‡æ–°æ’åˆ—ç»´åº¦ï¼‰
2. æ–°çš„stridesï¼ˆé‡æ–°æ’åˆ—ï¼‰

**ä»£ç æ¡†æ¶**ï¼š
```cpp
tensor_t Tensor::permute(const std::vector<size_t> &order) const {
    // TODO: å®ç°è¿™ä¸ªå‡½æ•°
    return std::shared_ptr<Tensor>(new Tensor(_meta, _storage));
}
```

---

### âœ… ä»»åŠ¡5ï¼š`slice()`

**åŠŸèƒ½**ï¼šæ²¿æŸä¸ªç»´åº¦åˆ‡ç‰‡

**ä¾‹å­**ï¼š
```
åŸå§‹ shape = [3, 4, 5]
slice(1, 1, 3) æ²¿ç¬¬1ç»´åˆ‡ç‰‡
æ–° shape = [3, 2, 5]  // 4å˜æˆäº† 3-1=2
```

**éœ€è¦è®¡ç®—**ï¼š
1. æ–°çš„shapeï¼ˆè¯¥ç»´åº¦å˜å°ï¼‰
2. æ–°çš„offsetï¼ˆç§»åŠ¨èµ·å§‹ä½ç½®ï¼‰

**ä»£ç æ¡†æ¶**ï¼š
```cpp
tensor_t Tensor::slice(size_t dim, size_t start, size_t end) const {
    // TODO: å®ç°è¿™ä¸ªå‡½æ•°
    return std::shared_ptr<Tensor>(new Tensor(_meta, _storage));
}
```

---

## ğŸ§ª ç¬¬äº”æ­¥ï¼šæµ‹è¯•ä½ çš„ä»£ç 

### è¿è¡Œæµ‹è¯•å‘½ä»¤ï¼š
```bash
cd /home/haoyue/workspace/llaisys
python test/test_tensor.py
```

### æµ‹è¯•æ–‡ä»¶å†…å®¹ï¼ˆtest/test_tensor.pyï¼‰ï¼š
```python
# åˆ›å»ºä¸€ä¸ªå½¢çŠ¶ä¸º (3, 4, 5) çš„æµ‹è¯•å¼ é‡
torch_tensor = torch.arange(60, dtype=torch.int64).reshape(3, 4, 5)

# æµ‹è¯• load()
llaisys_tensor.load(torch_tensor.data_ptr())

# æµ‹è¯• isContiguous()
assert llaisys_tensor.is_contiguous() == torch_tensor.is_contiguous()

# æµ‹è¯• view()
llaisys_tensor_view = llaisys_tensor.view(6, 10)

# æµ‹è¯• permute()
llaisys_tensor_perm = llaisys_tensor.permute(2, 0, 1)

# æµ‹è¯• slice()
llaisys_tensor_slice = llaisys_tensor.slice(2, 1, 4)
```

---

## ğŸ¯ å­¦ä¹ å»ºè®®

### ä»ç®€å•åˆ°å¤æ‚ï¼š
1. âœ… **å…ˆå®ç° `load()`** - æœ€ç®€å•ï¼Œåªæ˜¯å¤åˆ¶å†…å­˜
2. âœ… **ç„¶å `isContiguous()`** - çº¯é€»è¾‘ï¼Œä¸æ¶‰åŠå†…å­˜ç®¡ç†
3. âš ï¸ **å†å®ç° `view()`** - éœ€è¦ç†è§£stride
4. âš ï¸ **ç„¶å `permute()`** - éœ€è¦é‡æ–°æ’åˆ—ç»´åº¦
5. âš ï¸ **æœ€å `slice()`** - éœ€è¦è®¡ç®—offset

### è°ƒè¯•æŠ€å·§ï¼š
```cpp
// åœ¨å‡½æ•°ä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
std::cout << "Debug info..." << std::endl;
this->debug();  // è°ƒç”¨ç°æœ‰çš„debugå‡½æ•°
```

### å¦‚æœå¡ä½äº†ï¼š
1. æŸ¥çœ‹ PyTorch çš„æ–‡æ¡£ç†è§£è¿™äº›å‡½æ•°çš„è¡Œä¸º
2. åœ¨Pythonä¸­ç”¨PyTorchå®éªŒï¼š
   ```python
   import torch
   t = torch.arange(12).reshape(3, 4)
   print(t.shape)
   print(t.stride())  # æŸ¥çœ‹stride
   ```

---

## ğŸ“ é‡è¦çš„ä»£ç å‚è€ƒ

### Tensoræ„é€ å‡½æ•°ï¼ˆç¬¬11-12è¡Œï¼‰ï¼š
```cpp
Tensor::Tensor(TensorMeta meta, core::storage_t storage, size_t offset)
    : _meta(std::move(meta)), _storage(std::move(storage)), _offset(offset) {}
```

### åˆ›å»ºæ–°å¼ é‡çš„æ¨¡å¼ï¼š
```cpp
// åˆ›å»ºæ–°çš„å…ƒæ•°æ®
TensorMeta new_meta = ...;

// å¤ç”¨ç›¸åŒçš„storageï¼ˆä¸å¤åˆ¶æ•°æ®ï¼‰
tensor_t result = std::shared_ptr<Tensor>(new Tensor(new_meta, _storage, _offset));

return result;
```

---

## ğŸš€ å¼€å§‹åŠ¨æ‰‹ï¼

ç°åœ¨ä½ å·²ç»äº†è§£äº†æ‰€æœ‰åŸºç¡€çŸ¥è¯†ï¼Œå»ºè®®ï¼š

1. **ä» `load()` å¼€å§‹** - å‚è€ƒç¬¬157è¡Œçš„ä»£ç æ¨¡å¼
2. **é€ä¸ªå®ç°** - æ¯å®ç°ä¸€ä¸ªå°±è¿è¡Œæµ‹è¯•
3. **é‡åˆ°é”™è¯¯** - ä»”ç»†é˜…è¯»é”™è¯¯ä¿¡æ¯ï¼Œä½¿ç”¨debug()è¾“å‡º

**å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å®ç°ç¬¬ä¸€ä¸ªå‡½æ•°å§ï¼** ğŸ‰
